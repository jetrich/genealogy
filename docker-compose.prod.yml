version: '3.8'

# Production override for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # Laravel Application - Production Configuration
  app:
    build:
      target: production
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=https://yourdomain.com
      - LOG_LEVEL=warning
      - SESSION_SECURE_COOKIE=true
      - SESSION_SAME_SITE=strict
    volumes:
      # Remove development volume mounts
      - genealogy_storage:/var/www/html/storage/app
      - genealogy_logs:/var/www/html/storage/logs
      - genealogy_photos:/var/www/html/storage/app/public/photos
      - genealogy_gedcom:/var/www/html/storage/app/public/gedcom
      - genealogy_backups:/var/www/html/storage/app/backups
      - genealogy_cache:/var/www/html/bootstrap/cache
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # MySQL - Production Configuration
  mysql:
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --sql-mode=STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
      --max-connections=500
      --innodb-buffer-pool-size=1G
      --innodb-log-file-size=256M
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Redis - Production Configuration
  redis:
    command: redis-server /usr/local/etc/redis/redis.conf --save 900 1 --save 300 10 --save 60 10000
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.125'

  # Queue Worker - Production Configuration
  queue:
    build:
      target: production
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600 --memory=128
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.125'

  # Scheduler - Production Configuration
  scheduler:
    build:
      target: production
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.125'
        reservations:
          memory: 64M
          cpus: '0.0625'

  # Enable backup service in production
  backup:
    profiles: []  # Remove from profiles to enable by default

  # Nginx Reverse Proxy for SSL termination (production only)
  nginx-proxy:
    image: nginx:alpine
    container_name: genealogy_nginx_proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/proxy.conf:/etc/nginx/conf.d/default.conf
      - ./docker/ssl:/etc/ssl/certs
    depends_on:
      - app
    networks:
      - genealogy_network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.125'
        reservations:
          memory: 64M
          cpus: '0.0625'

  # Watchtower for automatic updates (production only)
  watchtower:
    image: containrrr/watchtower
    container_name: genealogy_watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 2 * * SUN  # Update every Sunday at 2 AM
      - WATCHTOWER_NOTIFICATIONS=email
      - WATCHTOWER_NOTIFICATION_EMAIL_FROM=${WATCHTOWER_EMAIL_FROM}
      - WATCHTOWER_NOTIFICATION_EMAIL_TO=${WATCHTOWER_EMAIL_TO}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=${WATCHTOWER_EMAIL_SERVER}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=${WATCHTOWER_EMAIL_PORT}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=${WATCHTOWER_EMAIL_USER}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=${WATCHTOWER_EMAIL_PASSWORD}
    networks:
      - genealogy_network
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.0625'